**路由器结构概况**

输入端口、输出端口、交换结构将输入和输出端口连接起来

路由：运行路由选择算法/协议生成路由表

转发：从输入到输出链路交换数据报，根据路由表进行分组的转发。

输入端口和输出端口通常整合在一起。

**输入端口的功能**

<img src="C:\Users\cyj250\AppData\Roaming\Typora\typora-user-images\image-20210310163946045.png" alt="image-20210310163946045" style="zoom: 200%;" />

* 根据数据报头部字段的信息如目的地址，在输入端口内存中的转发表中查找合适的输出端口（匹配+行动）

  > 使用前缀匹配法，最长匹配原则。
  >
  > 查找必须采用：必须出现物理层和链路层处理；必须检查分组版本号；必须更新用于网络管理的计数器。

  * 执行终结入物理链路的物理层。显示在图中输入端口最左侧的方框与输出端口部分最右侧的方框中。
  * 与位于入链路远端的数据链路层交互来执行数据链路层功能。中间方框。
  * 执行查找功能。最右侧方框。

* 基于目标的转发：仅仅依赖于IP数据报的目标IP地址（传统方法）

* 通用转发：基于头部字段的任意集合进行转发。

**输出端口**

输出端口存储从交换结构接收的分组，并通过执行必要的链路层和物理层功能在输出链路上传输这些分组。

**输入端口缓存**

* 当交换机的速率小于输入端口的汇聚速率时，在输入端口可能要排队。存在排队时延及由于输入缓存溢出造成丢失。
* 排在队头的分组阻止其他分组前进。

**路由选择处理器**

执行控制平面的功能。在传统路由器中，执行路由选择协议，维护路由选择表与关联链路状态信息，并为该路由器计算转发表。在SDN中，负责与远程控制器通信，目的是接收由远程控制器计算的转发表项，并在该路由器的输入端口安装这些表项。还执行网络管理功能。

**交换结构**

* 将分组从输入缓冲区传输到合适的输出端口。这种交换结构完全包含在路由器之中，即它是一个网络路由器中的网络。
* 交换速率：分组可以按照该速率从输入传输到输出
  * 运行速度通常是输入/输出链路速率的若干倍
  * N个输入端口，交换机的交换速度应是输入线路速度的N倍比较理想。
* 3种典型的交换机构

   memory、bus、crossbar

<img src="C:\Users\cyj250\AppData\Roaming\Typora\typora-user-images\image-20210310170800781.png" alt="image-20210310170800781" style="zoom: 200%;" />

	1. 经内存交换。就是传统的计算机作为路由器，交换在CPU的直接控制下完成。受内存限制。
 	2. 经总线交换。输入端口经一根共享总线将分组直接传送到输出端口，不需要路由选择处理器的干预。工作流程：输入端口为分组预先计划一个交换机内部标签（首部），指示本地输出端口，使分组在总线上传送和传输到输出端口。该分组能由所有输出端口收到，但只有与该标签匹配的端口能保存该分组，然后标签被去除。一次只能有一个分组跨越单一总线，其他分组必须等待，因此路由器的交换带宽受总线速率的限制。
 	3. 经互联网络交换。纵横式网络。



**排队**

1. 输入排队

   交换结构不能使所有分组无时延地通过它传送。

   线路前部阻塞：在输入队列中排队的分组必须等待通过交换结构发送，它被位于线路前部的另一个分组所阻塞。

2. 输出排队

   <img src="C:\Users\cyj250\AppData\Roaming\Typora\typora-user-images\image-20210310173912231.png" alt="image-20210310173912231" style="zoom:200%;" />

**分组调度**

确定次序的问题

1. 先进先出

   ![image-20210310174132105](C:\Users\cyj250\AppData\Roaming\Typora\typora-user-images\image-20210310174132105.png)

2. 优先权排队

   到达输出链路的分组被分类放入输出队列中的优先权类。

![image-20210310174556837](C:\Users\cyj250\AppData\Roaming\Typora\typora-user-images\image-20210310174556837.png)

每个优先权类通常有自己的队列。当选择一个分组时，优先权排队规则将从队列为飞空的最高优先权类中传输一个分组。在同一优先权类的分组之间通常用FIFO方式完成。

3. 循环和加权公平排队

   分组像使用优先权排队那样被分类，但不存在严格的服务优先权，循环调度器在这些类之间轮流提供服务。

   加权公平排队：

   ![image-20210310175434394](C:\Users\cyj250\AppData\Roaming\Typora\typora-user-images\image-20210310175434394.png)



